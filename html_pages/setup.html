<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <script defer src="/alpine.js" type="module"></script>
  <link rel="stylesheet" href="/style.css" />
  <title>Setup - TeslaBoard</title>
</head>
<body>
<header x-data="{ open: false }" @resize.window="width = (window.innerWidth > 0) ? window.innerWidth : screen.width;if (width > 767) {open = false}">
<nav class="bg-gray-800">
<div class="max-w-6xl mx-auto px-4">
<div class="flex justify-between">
  <div class="self-center">
  <!-- Website Logo -->
  <span class="font-semibold text-lg">StefanoTesla</span>
  </div>
  <!-- Primary Navbar items -->
  <div class="hidden md:flex items-center space-x-1">
    <a href="/" class="py-4 px-2 font-semibold hover:text-green-500 transition duration-300">Home</a>
    <a href="/setup" class="py-4 px-2 font-semibold hover:text-green-500 transition duration-300">Setup</a>
  </div>
  <!-- Mobile menu button -->
  <div class="md:hidden flex items-center h-14" >
    <button class="outline-none mobile-menu-button" @click="open = ! open">
    <svg class="w-6 h-6 text-gray-500 hover:text-green-500" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor">
    <path d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
    </button>
    </div>
    </div>
  </div>
  <!-- mobile menu -->
  <div x-show="open" class="mobile-menu">
  <ul class="">
    <li><a href="/" class="block text-sm px-2 py-4 hover:bg-green-500 transition duration-300">Home</a></li>
    <li><a href="/setup" class="block text-sm px-2 py-4 hover:bg-green-500 transition duration-300">Setup</a></li>
  </ul>
  </div>
  </nav>
  </header>
  <div class=""><h1 class="text-center text-xl">StefanoTesla Dome&Switch</h1></div>
    <div x-data="globalData()">
    <!--DOME-->
    <div class="main-tab bg-slate-600"
      x-data="{open:false}"
      >

      <div class="tab-header" >
        <div class="grow">Dome</div>
        <div><button @click="open = ! open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" stroke="#fff" fill="#fff"><path d="M12 3v2h5.586L5 17.586V12H3v9h9v-2H6.414L19 6.414V12h2V3h-9z"/></svg></button></div>
      </div>

      <div class="tab-content" x-show="open" x-transition>
        <div>
          <p>Pin Start Shutter: <input type="number" id="dometout" class="bg-gray-100 p-2 text-gray-800 h-5" x-model="dome.pinstart"/></p>
          <p>Pin Halt Shutter: <input type="number" id="dometout" class="bg-gray-100 p-2 text-gray-800 h-5" x-model="dome.pinhalt"/></p>
          <p>Pin Shutter Open: <input type="number" id="dometout" class="bg-gray-100 p-2 text-gray-800 h-5" x-model="dome.pinopen"/></p>
          <p>Pin Shutter Close: <input type="number" id="dometout" class="bg-gray-100 p-2 text-gray-800 h-5" x-model="dome.pinclose"/></p>
      </div>
        <div>
            <p>Timeout Posizionamento: <input type="number" id="dometout" class="bg-gray-100 p-2 text-gray-800 h-5" x-bind:value="dome.tout" x-model="dome.tout"/> Sec.</p>
        </div>
        <div>
          <p class="pt-2">Abilita chiusura in caso di mancata connessione: <input type="checkbox" id="dome.enautoclose" class="bg-gray-100 p-2 text-gray-500" x-bind:value="dome.enautoclose" x-model="dome.enautoclose"/> </p>
          <p class="text-xs italic">In caso di mancate richieste da parte dei driver ascom o portale web, lo shutter si chiude automaticamente dopo un tot tempo.</p>
        <p>Tempo di inattivit√†: <input type="number" id="domeautoclose" class="bg-gray-100 p-2 text-gray-800 h-5" x-bind:value="dome.autoclose" x-model="dome.autoclose"/> Min.</p>
        </div>
        <div class="pt-2">
            <button @click="saveDomeSetting()" class="button button_green">Salva</button>
            <a href="/domeconfig.txt" download class="button button_green">Scarica Configurazione</a>
        </div>

      </div>

    </div>

    <!--SWITCH-->
    <div class="main-tab bg-slate-600"
      x-data="{open:false}">

    <div class="tab-header" >
      <div class="grow">Switch</div>
      <div><button @click="open = ! open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" stroke="#fff" fill="#fff"><path d="M12 3v2h5.586L5 17.586V12H3v9h9v-2H6.414L19 6.414V12h2V3h-9z"/></svg></button></div>
    </div>

    
    <div class="tab-content pt-4" x-show="open" x-transition>

        <template  x-for="(swi, index) in switches" >
            <div class="my-2 py-2 px-2 rounded-md bg-slate-900">
                <p class="pt-2">Nome: <input type="text" x-on:change.debounce="validateString($event)" x-model="swi.name" class="bg-gray-100 p-2 text-gray-800 h-5" maxlength="32"/></p>
                <p class="pt-2">Descrizione: <input type="text" x-on:change.debounce="validateString($event)" x-model="swi.desc" class="bg-gray-100 p-2 text-gray-800 h-5" maxlength="32"/> </p>
                <div class="flex">
                  <p class="pt-2">Tipo: </p>
                  <select class="text-gray-800 px-2" x-model="swi.type">
                    <option id="1" value="1">Digital Output</option>
                    <option id="2" value="2">Digital Input</option>
                    <option id="3" value="3">PWM Output</option>
                    <option id="4" value="4">Analog Input</option>
                  </select>
                </div>
                <p class="pt-2">Pin: <input x-on:change.debounce="validatePinNumber($event)" x-model="swi.pin" type="number" id="dometout" min="1" max="32" class="bg-gray-100 p-2 text-gray-800 h-5"/></p>
                <div x-show="swi.type > 2">
                  <p class="pt-2">Valore minimo: <input x-model="swi.min" type="number" id="dometout" min="1" max="32" class="bg-gray-100 p-2 text-gray-800 h-5"/></p>
                  <p class="pt-2">Valore Massimo: <input x-model="swi.max" type="number" id="dometout" min="1" max="32" class="bg-gray-100 p-2 text-gray-800 h-5"/></p>
                </div>
                <button @click="removePin(index)" class=" mt-4 button button_red">Rimuovi</button>
            </div>
        </template>

        <div class="py-4">
          <button @click="addPin()" class="button bg-yellow-600">Aggiungi Nuovo Switch</button>

      </div>
    <div class="pt-2">
        <button @click="savePinSetting()" class="button button_green">Salva</button>
        <a href="/switchconfig.txt" download class="button button_green">Scarica Configurazione</a>
    </div>
    </div>
    </div>

</div>


  <script>
    function globalData() {
      return {
        dome: [],
        switches : [],
        reload() {
          this.dome = [];
          this.switches = [];
        },
        updateData(){fetch('/config').then(response => response.json()).then(response => {this.dome = response.dome; response.switches.forEach((element,index) => (this.switches.push(element)))});},
        init() {this.updateData()},
        validateString(event){
            event.target.value = event.target.value.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi, '');
        },
        validatePinNumber(event){
            let ionumber = parseInt(event.target.value);
            if (typeof ionumber === 'number' && !Number.isNaN(ionumber) && ionumber > 0 && ionumber < 37){
                this.switchNumber = ionumber
            } else {
                console.error("Errore di validazione", ionumber);
                event.target.value = 36;
            }
        },
        saveDomeSetting(){
            this.dome.autoclose = parseInt(this.dome.autoclose);
            this.dome.tout = parseInt(this.dome.tout);
            this.dome.pinstart = parseInt(this.dome.pinstart);
            this.dome.pinhalt = parseInt(this.dome.pinhalt);

            fetch('/domeconfig',{ 
              method: 'POST',
              headers: {"Content-Type": "application/json",},
              body: JSON.stringify(this.dome)
            })
            .then(response => response.json())
            .then(response => {
                  this.dome.error = response.error
              });
        },
        savePinSetting(){
          fetch('/switchconfig',{ 
              method: 'POST',
              headers: {"Content-Type": "application/json",},
              body: JSON.stringify(this.switches)
            })
            .then(response => response.json())
          console.log(JSON.stringify(this.switches))
        },
        addPin(){if(this.switches.length < 16){ this.switches.push({name: '',desc: '',type: '1',pin: '',min:'0',max:'1',});} else { console.error("Limite Raggiunto")}},
        removePin(index) {this.switches.splice(index, 1);}

    };
  }


  </script>
  </body>
</html>
